<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="referrer" content="origin">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>免杀基础知识</title>
    <link rel="shortcut icon" href="#"/>

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/LongCang.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Monda.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/NotoSansSC.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Playball.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/PTMono.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/RobotoSlab.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Rosario.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/UbuntuMono.css">

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/post.css">
    
        <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/normal.css">
    

    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/jquery-3.4.1.min.js"></script>

</head>
<body>
    <a id="cover"></a>
    <div id="header">
    <div class="header">
        <div class="vertical">
            <div class="inner">
                <h1 class="header-subtitle">免杀基础知识</h1>
                <div class="header-subinfo">
                    <p class="article-info-text">
                        <span>
                            <i class="iconfont icon-time"></i> 发表时间：2021-12-22
                        </span>
                        
                            <span id="/2021/12/22/免杀基础知识/" class="leancloud_visitors" data-flag-title="免杀基础知识">
                                <i class="iconfont icon-browse"></i> 阅读：<sapn class="leancloud-visitors-count"></span>
                            </span>
                        
                        <span>
                            <i class="iconfont icon-interactive"></i> 评论：<span class="valine-comment-count" data-xid="/2021/12/22/免杀基础知识/"></span>
                        </span>  
                    </p>                 
                </div>
            </div>
        </div>
        <canvas id="articleHeaderCanvas"></canvas>
    </div>
</div>
    <div id="container">
    <div id="content">
        <div id="article">
    <div class="toc"></div>
    <div class="article-body">
        <h1 id="免杀基础知识"><a href="#免杀基础知识" class="headerlink" title="免杀基础知识"></a>免杀基础知识</h1><p>距离上一篇文章已经快一个月，有考试的原因也有自己偷懒答案游戏的原因，感觉再不发这个博客就荒废了。</p>
<h3 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h3><p>​    在Windows上运行的程序，能够执行的有EXE、DLL、SYS、OCX等，这些都叫做<strong>可执行文件(Executable File)<strong>，也就是包含CPU指令、可以控制电脑硬件和指挥电脑的一类程序。这些可执行文件属于</strong>PE(Protable Executable)文件</strong>，是一种可移植的执行格式，这是一种具有特殊结构的程序，程序中包含数据、资源和指令。而<strong>文档(Document)<strong>又称数据文件，里面不含任何指令，但是能被可执行文件读取。病毒可以是EXE，也可以是DLL、SYS等，但是不可能是BMP、TXT之类的程序，因为这些程序都不能执行命令，那就代表它一定没有危险吗？当然不是，因为文件名其实并不能说明什么，重要的是文件内容和格式，因为但凡稍微改动一下注册表，就会让一个扩展名为txt的应用程序能够双击触发，这个牵涉到系统的文件关联(Association)机制，后面会讲到。</strong>DLL(Dynamic Link Libraries)<strong>是动态链接库文件，也属于可执行文件的一种，能够被其它EXE间接调用并执行，从某个角度而言，DLL比EXE更加危险，</strong>EXE运行后至少有一个进程(Process)，而DLL则没有进程</strong>，它的代码位于进程内部，要查看进程的DLL模块，就要用到第三方软件。**进程(Process)**是指程序活动的地方。一个程序，比如Windows记事本，文件名叫notepad.exe，运行后会创建一个进程，进程名也叫notepad.exe，路径是C:\Windows\System32\notepad.exe，其实这个路径是模块路径，进程本身是没有路径的，它就是一个空间，里面存放着各种不同的资源，其中包括一个exe和多个dll，这些exe和dll到了内存中，叫做模块(Module)，模块路径就是文件路径，进程路径是指EXE模块的文件路径。进程只是一个区域，执行任务的则是线程(Thread)。一个进程可以有多个线程，没有线程，它就成了僵尸进程，什么也做不了。如果我要同时做一些不同的任务，只需多创建一些线程即可。</p>
<h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><p>​    杀毒软件要控制另一个程序，就必须控制系统的<strong>API调用</strong>。<strong>API(Application Programming Interface，应用程序编程接口)<strong>函数是软件完成相应功能必须要调用的东西，一个API对应一个功能，参数决定功能的细节。API的本质就是一段代码，这些代码位于系统的DLL中，一个DLL文件含有若干API。举例说明，例如</strong>“结束进程”，就要调用一个TerminateProcess的API</strong>，任务管理器(Taskmgr.exe)里面终止一个进程，就是调用了它。当然，其它进程管理软件大多也是调用它。这个函数位于<strong>kernel32.dll</strong>中，而这个函数的代码里，会继续调用另一个更底层的<strong>API：ZwTerminateProcess(NtTerminateProcess)<strong>，Zw/Nt系列函数位于文件</strong>ntdll.dll</strong>中，也就是说ntdll.dll比kernel32.dll里的代码更接近系统底层，所以，你也可以直接调用ZwTerminateProcess去终止一个进程。然而，单独靠这个函数是无法结束其它进程的，还要有其它函数配合使用才行，要结束一个进程，<strong>首先要”打开”(Open)这个进程</strong>，OpenProcess(打开进程)函数正是负责干这个的。Windows下的每一个进程都有一个进程ID(ProcessId)，它是进程唯一的标识符，要打开进程，就要<strong>指定进程ID</strong>，标明你究竟要打开哪个进程，例如记事本notepad.exe的进程Id是1234，你就要OpenProcess这个1234，<strong>获取目标进程的句柄</strong>。句柄(Handle)你可以理解为一把钥匙，一种权限，有了对象的句柄，你才可以访问这个对象，就像有了钥匙才能开门一样。比如刚才我们打开了记事本的句柄，得到句柄值0x100，然后再TerminateProcess这个0x100，意思是终止句柄值为0x100这个进程，这样就把记事本给杀掉了。那么，如果我打开了记事本的进程得到0x100后，然后用另一个程序调用TerminateProcess去结束这个0x100，能把记事本给结束掉吗？答案是不能，因为首先句柄值是会变的，你这次打开得到0x100，下次再打开就可能会变成0x200，每次打开的值都是不同的，而且这个0x100是私有对象，只对打开它的程序有用，也就是说，0x100这个值属于你自己内部的东西，只对你有意义，对其它程序来说，0x100不代表任何进程。进程句柄属于内核对象句柄，除此之外，还有一种叫做<strong>GDI的句柄</strong>，这种句柄是不变的，例如窗口句柄(HWND)，窗口在创建后其句柄就保持不变，直到窗口销毁(Destroy)，也就是我们平时所说的关闭窗口。窗口句柄是公开的，完全暴露给用户，通常情况下任何进程都能访问。</p>
<blockquote>
<p>杀进程方法 <a target="_blank" rel="noopener" href="https://blog.csdn.net/zzmzzff/article/details/104681244">https://blog.csdn.net/zzmzzff/article/details/104681244</a></p>
</blockquote>
<h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><p>​    现在，当你在任务管理器里去结束一个进程，结果却提示拒绝访问，这是怎么回事呢？这是因为，你没有权限访问目标进程。一种可能是，你不是管理员(Administrator)，另一种可能是，这个进程被<strong>Hook</strong>了。为什么会被Hook呢？因为有进程采用了Hook API技术修改了这个函数地址，它钩住了OpenProcess这个API函数，当发现你要结束的进程是它时，因为打开进程进程被hook了，所以系统会跳过这个API，什么也不执行，直接返回。所以你收到的就不是进程句柄，而是0，既然打开失败，下一步结束进程就别谈了，只有当你有了句柄，有了所有权，你才能结束它，读写它，或者做其它什么都行，没有句柄，就什么也做不了。杀毒软件Hook了NtOpenProcess、NtTerminateProcess这些API，所以你想用普通的方法结束杀毒软件的进程，是没有用的，但是不代表不能用其它方法结束它的进程，如通过结束GUI界面来结束它。同样的，杀毒软件能够监控你的行为，得到你的一举一动，并随时准备kill掉你，也全是因为hook了和系统安全相关的API，所以才如鱼得水。</p>
<h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><p>​    杀软要监控系统，是从创建进程(CreateProcess)开始的，每一个进程都是由其它进程创建，记事本所以能运行，是因为你双击了一个TXT文件，而TXT又和Notepad.exe关联，所以系统就调用了Notepad，顺便传给它一个命令行参数(Command Line)，参数就是TXT文件的路径，Notepad运行后会检查自己后面是否带有参数，有的话就把它当成一个文件路径并打开它，如何处理参数则是程序员的事情。双击notepad.exe，或者从开始程序中选择记事本，或从开始-&gt;运行中输入notepad并打开，notepad都是由Explorer.exe这个进程来创建的，notepad的父进程就是Explorer.exe(Windows Shell进程)，就是我们通常所说的桌面进程。如果在cmd中输入命令并启动，这时启动后的程序的父进程就是cmd.exe。而Explorer.exe的父进程是userinit.exe，创建完Explorer后它就退出了，userinit的父进程是winlogon.exe(登录进程)，winlogon.exe的父进程是smss.exe(会话管理器，第一个进程，由内核创建)。杀软hook了NtCreateProcessEx、NtCreateSection等API，这样，任何进程启动都在它的监控之中，如果有可疑动作就弹窗提示或直接隔离。那么，hook究竟做了什么呢？其实hookAPI就是改掉目标进程API入口地址，跳转到它自己的地址，如果是这样的话，病毒运行后难道不会检查自己进程内存是否被修改过，从而再改回来吗？其实hook也分很多种，杀毒软件hook的不是目标进程的数据，而是系统内核数据，这就要谈到进程内存管理。</p>
<h3 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h3><p>   Windows系统每个进程的内存都各自独立，一个进程的崩溃不会影响到另一进程，更不会影响到操作系统进程，这是因为为了避免用户的代码波及系统内核代码，系统把内存划分开来，一个是用户内存，一个是内核内存，应用程序代码工作在用户模式(user mode)，操作系统的代码运行在内核模式(kernel mode)，这样用户进程发生的错误由自己承担，而不会引起系统崩溃。当程序需要到内核请求服务时，它会通过指令从用户模式切换到内核模式，完成服务后控制权会切换回来。Win32下每个进程都有一个虚拟的4GB内存空间，用户代码只能访问2GB以下空间，驱动程序代码可以访问全部空间，不过有一个64KB的区域，地址从0x7FFF0000-0x7FFFFFFF，这个地方它们都不能访问。EXE、DLL都在用户内存活动，而不会跑到内核内存，操作系统则在内核内存中运行，要访问内核内存的数据，就要写成驱动程序(Drivers)Sys格式，只有sys格式的可执行文件才有权限进入系统内核，从而获取系统的完全控制权。所以，杀毒软件都会有自己的驱动，也就是至少有一个sys文件，运行后加载到内存，便可充分进入Windows系统。如果驱动的代码存在漏洞，则可能会导致系统内核崩溃，从而引起蓝屏(BSOD)。蓝屏是驱动程序代码发生异常的结果，而EXE的代码是不会造成系统崩溃的，因为它没有访问系统内存的权限。从用户空间(ring3)进入内核空间(ring0)，需要经过一道门—-SSDT(System Services Descriptor Table)，称”系统服务描述符表”，这是一张系统服务表，ntdll.dll中的NT系列函数最终要访问的就是SSDT，所以要最终结束一个进程，必然要经过SSDT中的NtTerminateProcess函数，杀软在驱动中拦截了NtTerminateProcess、NtTerminateThread、NtOpenProcess等系统服务，从而保证自己不被ring3下的EXE程序干掉。SSDT最终要通往系统内核，去执行真正的代码，所以，要挂得彻底，就要挂钩内核，也就是inline Hook。不过，相对而言，SSDT更稳定，所以有些程序还是挂的SSDT，当然也有挂内核的，例如360。那如果病毒也进入内核怎么办？病毒一旦进入内核，杀毒软件就无法再对其进行安全控制，系统就被完全劫持，杀软的主防也就彻底失去了作用。所以，驱动病毒(Rootkit)是最危险的，如果一个程序要安装驱动，一定要确定它是安全的才能放行。</p>
<h3 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h3><p>​    可是，有些杀毒软件已经过滤了终止进程的服务，可为什么还是会被其它进程Kill掉呢？这是因为杀进程不一定要用标准的终止进程函数，还可以从它的GUI(图形用户界面)下手。早期的安全软件自我保护不够彻底，只单单保护了进程和线程，而没有保护窗口界面。Windows有一个消息通信机制，依靠消息传递来和窗口进行通信，窗口创建后会收到许多系统消息，如果病毒进程向杀毒软件发送了这些消息，杀软进程将会出现问题，甚至挂掉。比如要杀掉一个窗口，就向目标窗口发送WM_CLOSE、WM_QUIT、WM_DESTROY等消息，窗口就会被销毁，进程也随之退出。不过现在的杀软保护机制比以前要完善，这些消息如今已经过时了。但没有绝对的安全，任何程序都有漏洞(bug)，要干掉AV软件，就要寻找它的漏洞，然后给它致命一击。除此之外，Windows的消息还有好多，如WM_MOVE(移动窗口)，WM_SIZE(改变窗口大小)等等。那我有没有办法控制其它进程的窗口呢？办法是有的，还是调用系统API，例如我要移动记事本notepad的窗口，就必须先得到它的句柄(hWnd)，然后MoveWindow它或SetWindowPos它到任意位置。句柄怎么获取呢？可以通过EnumWindows、GetWindow、FindWindow等函数遍历系统所有窗口，然后再得到其标题和类名，就能大致找到它。</p>
<h3 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h3><p>​    但是，有些窗口却无法关掉，即使向它发送了WM_CLOSE，这是怎么回事？因为目标窗口Hook了WM_CLOSE消息，将它拦了下来。不急，我们还有其它方法，就是隐藏(Hide)它。系统有许多窗口，大部分都处于隐藏状态，只有少数能看见，”隐藏”属于窗口样式(Window Style)的一种，窗口样式也叫窗口风格，是指一个窗口的外观，就像人的相貌一样，不同的人长相不同，窗口也是如此。有些窗口能改变大小，有些不能，有些有最小化最大化按钮，有些一直位于顶层，还有些没有标题栏，甚至有些窗口是透明的，鼠标点击不到等等，这些都属于窗口的样式，要获取窗口的样式，就要GetWindowLong，改变一个窗口的样式要SetWindowLong，比如要隐藏一个窗口就要把它的WS_VISIBLE样式去掉，当然通常的做法是ShowWindow(显示窗口)，ShowWindow可以将目标窗口隐藏或显示、最小化及最大化，实际上依然是改变了窗口的样式。同样的，要让一个窗口永远处于最前面，就要用SetWindowPos，给它添加一个WS_EX_TOPMOST样式。有些窗口比较特别，它们是编程中的控件(Control)，比如TextBox、ListBox，Button等，控件本质也是窗口，只不过是子窗口，是属于某个窗口内部的窗口，这样的窗口不能移出它的父窗口，子窗口除了具有标准窗口的样式之外，还有它自己独特的Style，子窗口可以再有子窗口，如此形成窗口树，这一点和进程差不多。获取子窗口用GetWindow，获取父窗口可以用GetParent，不过不建议使用，因为GetParent这个API有问题，它有时会取到”所有者”(Owner)窗口，获取父窗最好用GetAncestor。每个窗口都有一个顶级父窗，叫做”桌面”(Desktop)，这个桌面不是Explorer的桌面，而是系统内核win32k.sys创建的窗口，属于win32子系统进程csrss.exe的窗口，但是有些可能不属于Desktop，例如消息(Message)窗口。另外，窗口还有其它属性，比如窗口大小，获取窗口尺寸用GetWindowRect，这个API会取到一个矩形(Rect)，Rect由两个点(Point)组成，一个是窗口左上角坐标，一个是窗口右下角坐标，当窗口最小化时是取不到的，只能用GetWindowPlacement得到它的还原矩形。窗口是由进程创建的，确切地说是由线程创建的，所以每个窗口一定都有一个对应的进程和线程，比如桌面图标窗口(Progman)、任务栏窗口(Shell_TrayWnd)以及文件管理器窗口(ExploreWClass)，都属于Explorer.EXE进程。当我们双击一个txt或jpg也会产生一个窗口，这个窗口是个exe程序，或者说是一个软件，软件和相关文件类型存在关联所以才能自动调用EXE，而txt和jpg是不会有窗口的。窗口除了窗口矩形，还有客户矩形(Client Rect)，客户矩形是一个窗口的工作区，是可以通过代码控制的部分，是程序员可以直接访问的那片区域，而非客户区(Not Client)则由Windows系统控制，标题栏(CaptionBar)、菜单栏(MenuBar)、窗口边框(Border)都属于非客户区。注意，菜单栏不一定是含有菜单的栏目，它也可能是伪菜单栏，比如工具栏(ToolBar)或自绘控件。工具栏是一个窗口，属于窗口类，而菜单栏不是窗口，没有句柄，它只是窗口非客户区的一个区域罢了，如资源管理器中的菜单栏，实际上是一个ToolBar窗口，仍然属于客户区部分。获取窗口属性的常用工具有Spy++、ViewWizard等。</p>
<h3 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h3><p>​    所谓知己知彼，百战百胜，杀软要对付病毒，就要知道它的原理，知道它一般要干些什么事。早期的病毒一般是感染，感染可执行文件，病毒遍历所有EXE文件并将它自己的文件Bytes写入EXE之前，这样双击一个EXE，首先启动的就是病毒程序，病毒程序获取控制权后，再回到原始文件的代码入口执行原来的程序代码，这样用户便发现不了它的踪迹，还有些则是纯属玩笑程序(Joke)。而如今的病毒程序一般以木马为主，他们利用木马入侵用户的计算机并从中获取利益。典型的木马程序有键盘记录(Keyboard Logger)、勒索程序等。</p>
<p>键盘记录的方式有很多，比如消息钩子、定时截取按键、过滤驱动等。消息钩子最为常见，病毒启动后通过SetWindowsHookEx注册一个系统钩子，然后就能监控到系统全局的按键。一种方式是通过DLL注入系统所有GUI进程获取记录，另一种是通过低级钩子(WH_KEYBOARD_LL)捕获记录，定时截获一般是通过GetKeyState、GetAsyncKeyState等函数截取记录，DirectX游戏按键记录等，更底层的则是直接释放一个键盘过滤驱动(Filter Driver)到用户电脑。另一种形式是通过发送WM_GETTEXT、EM_GETPASSWORDCHAR获取编辑框和密码框的内容，来达到记录用户输入信息的目的。钩子的作用不仅限于键盘记录，它还有其它许多作用，相比之下，另一种技术则显得有些过时，它是远线程注入(Insert Thread),一般的程序不需要什么注入其它进程，所以但凡调用CreateRemoteThread则基本会被认定是木马。还有种病毒属于恶意程序，专门搞破坏，比如删除文件，格式化磁盘，改文件夹图标，伪装成文件夹等，这种病毒行为虽然简单，但破坏性却很为严重，看似简单的东西反而是最危险的。与EXE病毒相比，DLL病毒则更加可怕，如LPK.dll病毒，它和系统文件lpk.dll同名，运行后在本机搜索WinRAR等压缩器程序，然后将自己写入到压缩包中去，属性设为隐藏。当用户双击EXE后，EXE会在当前目录下寻找lpk.dll，找到的话就加载，随之病毒就从Dll入口处执行目标代码。对付它的办法是在注册表中声明该DLL库，使程序在运行后先到系统目录(system32)中寻找该DLL，而不是先到应用程序目录下寻找该库文件。所以说设置成”显示所有文件”是有必要的，真正重要的东西不必隐藏，而应该加密。中了病毒重装系统就没事了吗？并不是的，有时病毒会将自己复制到所有分区下，恢复系统只是恢复了系统盘(C盘)，而其它盘并没有发生改变(D盘可能会被安装些程序)，所以如果你不小心又运行了其它盘的病毒，那就悲剧了。病毒的启发方式也有很多，如改变注册表关联，改IFEO(映像劫持)，写Autorun.inf等。在资源管理器中双击一个程序，并没有立即为它创建进程，而要到注册表寻找其对应的另一个程序，病毒将目标程序篡改，从而达到偷粱换柱的目的。一个进程运行的步骤是：shell32.ShellExecute-&gt;kernel32.CreateProcess-&gt;ntdll.ZwCreateProcessEx，最后是SSDT的NtCreateProcessEx。双击是从ShellExecute开始执行的，到了ntdll时，进程目标才得以确定，中途可以在注册表中改掉目标</p>
<h3 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h3><p>仅运行了起来是远远不够的，病毒还要将自己写入自启动列表，以便长久落脚。自启动是一项很复杂的机制，有开始菜单启动、注册表开机启动，还有服务启动、驱动启动、DLL启动等。自启目标未必是EXE，只要代码到了内存就会执行，有时一个程序后台启动了，但却无论如何找不到它的启动项，这是因为它采用了DLL的方式启动。工欲善其事，必先利其器，要查看这些启动项就要用到利器，Autoruns就是专门干这个的。要阻止病毒，就要充分了解启动项，从一定上意义讲，阻止了自启，就等于阻止了病毒。只要它不自启，重启电脑后它也就不会再运行，不运行就没有控制权，那么我们就有时间揪出潜藏在深处的恶意程序。<br>      病毒要生存就要首先保护自己。隐藏(Hide)和伪装是一个有效的方法，首先要隐藏进程，那要就hook掉获取进程的API，最基本的是在系统的任务管理器(Taskmgr)中隐藏自己，Taskmgr获取进程用的是NtQuerySystemInformation，那病毒就要hook掉该API，抹去自己。然后是伪装，比如伪装成系统进程的名字，如svchost.exe，或者修改模块PEB伪装自己的路径。接下来是隐藏文件，hook掉NtQueryDirectoryFile(查询目录文件)，在资源管理器就看不到它了。除了隐藏和伪装，还可以保护，比如像杀软一样过滤掉NtOpenProcess等API，就能防止Taskmgr结束自己，但如果碰到驱动级管理器就无效了，带驱动的辅助工具称为ARK，也就是反内核工具，它工作在ring0层，属于手杀工具的一种，它不但能够保护自己，还能检查系统内核的状态，判断内核代码是否异常，当然还具有强杀功能，比较有知名度的软件代表是IceSword(冰刃)、PCHunter(原XueTr)、PowerTool等，ring3下的工具比较少，比如我编写的FxIce(XP下可用，现已开源)。进程要删除一个文件，必须用到DeleteFile，包括Explorer在内，DeleteFile前要先SetFileAttributes，以便移除文件的只读(ReadOnly)属性，因为”只读”文件是无法删除的。病毒要防止自己被删除，就要在内核中的Hook NtDeleteFile和NtSetInformationFile，防止自己被访问就要Hook NtCreateFile、NtOpenFile。和进程一样，文件也有文件句柄hFile，要读写一个文件，首先要OpenFile或CreateFile这个文件，得到一个句柄(Handle)，然后才能对其WrieFile或ReadFile，句柄用完要关闭(CloseHandle)它，以便释放资源。最后是保护窗口，首先是隐藏，这里是指改变它的Style，让自己不再拥有Visible(显示)属性，其次是在内核中隐藏自己的信息或者挂上内核钩子，让ring3(用户模式)下的进程无法获取到自己的信息，比如在ShadowSSDT中Hook NtUserQueryWindow、NtUserFindWindowEx等。</p>
<h3 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h3><p>远方235大佬真的太强了 直接刷新了我对于安全的三观 可以去他的csdn博客看看</p>

        <p class="suffix-end">__END__</p>
        <div class="suffix-box">
            <div class="suffix-box-left">
                <img src="/image/cyc2018.png" alt="Think Twice Code Once">
            </div>
            <div class="suffix-box-right">
                <span class="suffix-box-title">文章作者</span>：Think Twice Code Once
                <br>
                <span class="suffix-box-title">文章出处</span>：<a href="/2021/12/22/%E5%85%8D%E6%9D%80%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" target="_blank">免杀基础知识</a>
                <br>
                <span class="suffix-box-title">作者签名</span>：Stay Foolish Stay Hungry
                <br>
                <span class="suffix-box-title">关于主题</span>：<a href="https://github.com/first19326/Hexo-LiveForCode" target="_blank">Hexo - Live For Code</a>
                <br>
                <span class="suffix-box-title">版权声明</span>：文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" title="BY-NC-SA" target="_blank">BY-NC-SA</a> 许可协议，转载请注明出处
                <br>
            </div>
            <div style="clear: both;"></div>
        </div>
    </div>
    <div class="article-footer">
        
        
        <div class="article-prev-next">
            
            
                <a href="/2021/11/24/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%911/" class="next-prefix">» </a> 下一篇：    <a href="/2021/11/24/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%911/" title="发布于 2021-11-24 11:17">西湖论剑1</a>
            
        </div>
    </div>
    
    <div class="article-comments">
        <div class="comments-title">
            评论列表
        </div>
        <div class="comments-content">
        </div>
    </div>

</div>

    </div>
</div>
    <div id="footer"></div>
    <div id="sidebar">
    <div class="menu-wrap" style="display:none;">
        <nav class="menu">
            <div class="menu-introduce"> 
                <div class="introduce-avatar"></div> 
                <div class="introduce-info"> 
                    <div class="introduce-user"><span></span></div>        
                </div> 
            </div> 
            <div class="menu-list">
                <ul></ul> 
            </div> 
            <div class="menu-link"></div> 
        </nav>
        <button class="menu-button-close"></button>
        <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
            </svg>
        </div>
    </div>
    <button class="menu-button-open">MENU</button>
    <div class="menu-cover"></div>
</div>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/search.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/iscroll.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/instantsearch.min.js"></script>
<div class="search-window">
    <div class="search-content">
        <div class="search-content-icon">
            <i class="iconfont icon-search"></i>
        </div>
        <div id="search-input" class="search-input"></div>
    </div>

    <div class="search-scroll">
        <div class="search-result">
            <div id="search-stats" class="search-stats"></div>
            <div id="search-hits"></div>
            <div id="search-pagination" class="search-pagination"></div>
        </div>
    </div>

    <span class="search-close-icon">
        <i class="iconfont icon-close"></i>
    </span>
</div>
    <div id="tools">
    <div class="progressbar-top"></div>

    
        <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/APlayer.css">
        <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/APlayer.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/Meting.min.js"></script>
        <meting-js id="3778678" lrcshow="false" server="netease" type="playlist" fixed="true" autoplay="false" loop="all" order="random" preload="auto" volume="0.67" mutex="true"></meting-js>
    
    
    <div class="wrap-right"></div>
    <div class="loading"></div>
</div>
    <script>
    window.config = {
        GitHubUserName     : 'invmacking',
        GitHubRepositories : 'invmacking.github.io',

        BlogUser      : 'Think Twice Code Once',
        BlogAvatar    : '/image/cyc2018.png',
        BlogStartDate : '2021-11-21',

        WebsiteTitleBlur         : 'Talk data 2 me',
        WebsiteTitleBlurTimeOut  : 500,
        WebsiteTitleFocus        : '(*´∇｀*) 欢迎回来!',
        WebsiteTitleFocusTimeOut : 1000,
        WebsiteFavicon           : '/image/logo.png',

        ProgressBar: {
            id       : 'topProgressBar',
            color    : '#77B6FF',
            height   : '2px',
            duration : 0.2
        },

        Loading: {
            rebound: {
                tension  : 16,
                friction : 5
            },
            spinner: {
                id     : 'spinner',
                radius : 90,
                sides  : 3,
                depth  : 4,
                colors : {
                    background : '#F0F0F0',
                    stroke     : '#272633',
                    base       : '',
                    child      : '#272633'
                },
                alwaysForward : true,
                restAt        : 0.5,
                renderBase    : false
            }
        },

        HomeHeaderAnimationRendered : true,
        HomeHeaderAnimation         : {
            radius      : 15,
            density     : 0.2,
            color       : 'rgba(255, 255, 255, .2)',
            clearOffset : 0.3
        },

        ArticleHeaderAnimationRendered : false,
        ArticleHeaderAnimation         : {
            triW                  : 14,
            triH                  : 20,
            neighbours            : [
                
                    'side',
                
                    'top',
                
                    'bottom',
                
            ],
            speedTrailAppear      : 0.1,
            speedTrailDisappear   : 0.1,
            speedTriOpen          : 1,
            trailMaxLength        : 30,
            trailIntervalCreation : 100,
            delayBeforeDisappear  : 2,
            colors                : [
                
                    '#96EDA6',
                
                    '#5BC6A9',
                
                    '#38668C',
                
                    '#374D84',
                
                    '#BED5CB',
                
                    '#62ADC6',
                
                    '#8EE5DE',
                
                    '#304E7B',
                
            ]
        },

        BackAnimationRendered          : true,
        IEBrowserBackAnimationRendered : false,
        BackAnimation                  : {
            colorSaturation  : '60%',
            colorBrightness  : '50%',
            colorAlpha       : 0.5,
            colorCycleSpeed  : 5,
            verticalPosition : 'random',
            horizontalSpeed  : 200,
            ribbonCount      : 3,
            strokeSize       : 0,
            parallaxAmount   : -0.2,
            animateSections  : true
        },

        HomeHeaderImage : [
            
                '/image/3.jpg',
            
                '/image/4.jpg',
            
                '/image/cumt.jpg',
            
        ],
        HomeBannerText  : '我与我周旋久，宁做我。',

        ArticleHeaderImage : [
            
                'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/image/header/article.jpg',
            
        ],

        OtherBannerText : '',

        MenuList : [
            
                {
                    name   : '首页',
                    href   : '/',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '分类',
                    href   : '/category',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '搜索',
                    href   : '',    
                    target : '',
                    class  : 'search'
                },
            
                {
                    name   : '留言板',
                    href   : '',    
                    target : '',
                    class  : '/comment'
                },
            
                {
                    name   : '关于我',
                    href   : '/about',    
                    target : '',
                    class  : ''
                },
            
                {
                    name   : '友情链接',
                    href   : '/friend',    
                    target : '',
                    class  : ''
                },
            
        ],
        MenuLink : [
            
                
                    {
                        icon : 'icon-weibo', 
                        url  : ''
                    },
                
                    {
                        icon : 'icon-wechat', 
                        url  : ''
                    },
                
                    {
                        icon : 'icon-qq', 
                        url  : ''
                    },
                
                    {
                        icon : 'icon-github', 
                        url  : 'https://github.com/first19326'
                    },
                
            
        ],

        FooterStyle : 2,
        BottomText  : {
            icon    : 'like-fill',
            left    : '他们试图将你埋了',
            right   : '但你要记得你是种子'
        },
        ThemeInfo   : true,

        ConsoleList : [
            
                
                    [
                        
                            
                                'Based on cnblogs theme SimpleMemory.',
                            
                                '',
                            
                        
                    ],
                
                    [
                        
                            
                                'SimpleMemory Author:',
                            
                                'BNDong',
                            
                        
                    ],
                
                    [
                        
                            
                                'Theme:',
                            
                                'LiveForCode',
                            
                        
                    ],
                
            
        ],

        FontIconExtend : '',

        Code : {
            style : 'normal'
        },  

        Search : {
            applicationID : '010C3EANT8',
            apiKey        : 'c7abab9f11b79102b9aff7fe6d41447d',
            indexName     : 'Notes',
            hits          : {
                page : 10
            },
            labels        : {
                placeholder : '搜索',
                empty       : '未发现与 「${query}」 相关的内容',
                stats       : '${hits} 条相关条目，使用了 ${time} 毫秒',
            }
        }, 

        Valine : {
            switch         : true,
            el             : '.comments-content',
            appId          : 'srhKtvWPQTWYKh3qX8G8M7v0-gzGzoHsz',
            appKey         : '8uVSP1q6UlALVC5igYfIfv2h',
            placeholder    : '你是我一生只会遇见一次的惊喜...',
            avatar         : 'mm',
            meta           : 'nick,mail,link',
            requiredFields : 'nick,mail',
            pageSize       : 5,
            lang           : 'zh-cn',
            visitor        : true,
            enableQQ       : true
        },

        Tocbot : {
            switch                : true,
            tocSelector           : '.toc',
            contentSelector       : '.article-body',
            headingSelector       : 'h1, h2, h3, h4, h5',
            headingsOffset        : 0,
            scrollSmooth          : true,
            scrollSmoothOffset    : -5,
            positionFixedSelector : '.toc',
            positionFixedClass    : 'toc-fixed',
            fixedSidebarOffset    : '',
        },

        Require : {
            baseUrl     : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/',
            waitSeconds : 100
        },

        Music : {
            type : 'Meting'
        },
        APlayer : {
            container : '.aplayer',
            fixed     : true,
            autoplay  : false,
            loop      : 'all',
            order     : 'random',
            preload   : 'auto',
            volume    : 0.67,
            mutex     : true,
            lrcType   : 3,
            audio     : [
                
                    {
                        name   : 'aLIEz',
                        artist : 'mizuki（瑞葵）',
                        cover  : '/music/cover/aLIEz.jpg',
                        url    : '/music/song/aLIEz.mp3',
                        lrc    : '/music/lrc/aLIEz.lrc'
                    },
                
                    {
                        name   : 'Endless Tears',
                        artist : 'CLIFF EDGE',
                        cover  : '/music/cover/Endless Tears.jpg',
                        url    : '/music/song/Endless Tears.mp3',
                        lrc    : '/music/lrc/Endless Tears.lrc'
                    },
                
                    {
                        name   : 'Miracle',
                        artist : 'Cascada',
                        cover  : '/music/cover/Miracle.jpg',
                        url    : '/music/song/Miracle.mp3',
                        lrc    : '/music/lrc/Miracle.lrc'
                    },
                
                    {
                        name   : 'Roll The Dice',
                        artist : '高珊',
                        cover  : '/music/cover/Roll The Dice.jpg',
                        url    : '/music/song/Roll The Dice.mp3',
                        lrc    : '/music/lrc/Roll The Dice.lrc'
                    },
                
                    {
                        name   : 'See You Again',
                        artist : 'Charlie Puth, Wiz Khalifa',
                        cover  : '/music/cover/See You Again.jpg',
                        url    : '/music/song/See You Again.mp3',
                        lrc    : '/music/lrc/See You Again.lrc'
                    },
                
                    {
                        name   : 'Traveling Light',
                        artist : 'Joel Hanson, Sara Groves',
                        cover  : '/music/cover/Traveling Light.jpg',
                        url    : '/music/song/Traveling Light.mp3',
                        lrc    : '/music/lrc/Traveling Light.lrc'
                    },
                
                    {
                        name   : '痴心绝对',
                        artist : '李圣杰',
                        cover  : '/music/cover/痴心绝对.jpg',
                        url    : '/music/song/痴心绝对.mp3',
                        lrc    : '/music/lrc/痴心绝对.lrc'
                    },
                
                    {
                        name   : '好想大声说爱你',
                        artist : 'BAAD（バード）',
                        cover  : '/music/cover/好想大声说爱你.jpg',
                        url    : '/music/song/好想大声说爱你.mp3',
                        lrc    : '/music/lrc/好想大声说爱你.lrc'
                    },
                
            ]
        },
        Meting : {
            id       : '3778678', 
            lrcshow  : false, 
            server   : 'netease', 
            type     : 'playlist', 
            fixed    : true, 
            autoplay : false, 
            loop     : 'all', 
            order    : 'random', 
            preload  : 'auto', 
            volume   : 0.67, 
            mutex    : true
        },

        Mouse : {
            enable  : true,
            options : {
                size  : 6,
                sizeF : 24
            }
        },

        LazyLoad : {
            default : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/image/website/lazyload.svg'
        },
  
        Style : {
            aplayer          : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/APlayer.css',
            archive          : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/archive.css',
            donate           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/donate.css',
            fancybox         : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/jquery.fancybox.css',
            footer           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/footer.css',
            iconfont         : 'https://at.alicdn.com/t/font_1546312_l3yohatebw.css',
            index            : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/index.css',
            menuBubble       : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/menu-bubble.css',
            page             : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/page.css',
            post             : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/post.css',
            search           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/search.css',
            tocbot           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/tocbot.css',
            normal           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/normal.css',
            night            : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/night.css',
            clipboard        : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/css/clipboard.css'
        },

        Script: {
            aplayer          : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/APlayer.min.js',
            config           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/require.config.js',
            index            : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/index.js',
            instantSearch    : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/instantsearch.min.js',
            jQuery           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/jquery-3.4.1.min.js',
            loading          : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/loading.js',
            meting           : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/Meting.min.js',
            iscroll          : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/iscroll.js',
            require          : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/require.min.js'
        },

        Font: {
            LongCang   : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/LongCang.css',
            Monda      : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Monda.css',
            NotoSansSC : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/NotoSansSC.css',
            Playball   : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Playball.css',
            PTMono     : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/PTMono.css',
            RobotoSlab : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/RobotoSlab.css',
            Rosario    : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/Rosario.css',
            UbuntuMono : 'https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/font/UbuntuMono.css'
        },

        Suffix : {
            about : 'Stay Foolish Stay Hungry'
        },
            
        Theme : {
            url  : 'https://github.com/first19326/Hexo-LiveForCode',
            name : 'Hexo - Live For Code'
        }  
    };
</script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/first19326/cdn@master/static/js/index.js"></script>
</body>
</html>
